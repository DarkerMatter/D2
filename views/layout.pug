doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    //- Add Google Fonts
    link(rel="preconnect", href="https://fonts.googleapis.com")
    link(rel="preconnect", href="https://fonts.gstatic.com", crossorigin)
    link(href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap", rel="stylesheet")

    //- Updated Title
    title FTS.GG | D2 Rage Counter
    link(rel="icon", type="image/png", href="/images/logo.png")

    //- Link to all the new, separated CSS files
    link(rel="stylesheet", href="/css/base.css")
    link(rel="stylesheet", href="/css/layout.css")
    link(rel="stylesheet", href="/css/components.css")
    link(rel="stylesheet", href="/css/pages.css")
    link(rel="stylesheet", href="/css/animations.css")
    //- Bootstrap Icons for achievements
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css")

  body.loading
    //- Loader Animation HTML
    .loader-wrapper
      .loader

    .container
      nav
        h1
          a(href="/") D2 Rage Counter
        ul
          li
            a(href="/leaderboard") Leaderboard
          li
            a(href="https://fts.gg/discord", target="_blank", rel="noopener noreferrer") Discord
          if user
            li
              a(href="/dashboard") Dashboard
            li
              a(href="/account") Account
            if user.permission_level === 5
              li
                a(href="/admin") Admin Panel
            li
              a(href="/logout") Logout (#{user.username})
          else
            li
              a(href="/login") Login
      main
        //- Container for our custom flash messages
        .flash-messages-container
          //- FIX: Check for messages.success instead of just success
          if messages.success && messages.success.length > 0
            each msg in messages.success
              .flash-message.flash-success
                .flash-icon ✔
                .flash-content
                  strong Success
                  p= msg
                button.flash-close(type="button") &times;
          //- FIX: Check for messages.error instead of just error
          if messages.error && messages.error.length > 0
            each msg in messages.error
              .flash-message.flash-error
                .flash-icon ✖
                .flash-content
                  strong Error
                  p= msg
                button.flash-close(type="button") &times;

        block content
      footer
        .footer-links
          a(href="https://fts.gg/discord", target="_blank", rel="noopener noreferrer") Discord
          span.separator |
          a(href="https://github.com/DarkerMatter/D2", target="_blank", rel="noopener noreferrer") GitHub
        p &copy; 2025 FTSGG LLC

    //- Modal HTML is now a direct child of the body, outside the main container
    #confirmation-modal.modal-overlay.hidden
      .modal-dialog
        h3.modal-title Confirmation Required
        p.modal-body Are you sure you want to proceed with this action?
        .modal-actions
          button.btn-secondary#modal-cancel-btn Cancel
          button.btn-danger#modal-confirm-btn Confirm

    //- Container for toast notifications
    #toast-container

    //- Chart.js library from CDN
    script(src="https://cdn.jsdelivr.net/npm/chart.js")

    //- Client-side scripts for UI interactions
    script.
      // Fades out the loader once the page's resources are fully loaded.
      window.addEventListener('load', () => {
        const loader = document.querySelector('.loader-wrapper');
        if (loader) {
          loader.classList.add('fade-out');
          document.body.classList.remove('loading');
        }
      });

      // Sets up all interactive elements once the DOM is ready.
      document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Re-activate loader on specific page navigations ---
        const loader = document.querySelector('.loader-wrapper');
        const body = document.body;
        const loadingLinks = document.querySelectorAll('a[href="/dashboard"], a[href="/account"], a[href="/admin"]');
        loadingLinks.forEach(link => {
          link.addEventListener('click', (e) => {
            if (e.ctrlKey || e.metaKey || e.which === 2) return;
            if (loader) {
              body.classList.add('loading');
              loader.classList.remove('fade-out');
            }
          });
        });

        // --- 2. Logic to make flash messages dismissible ---
        const closeButtons = document.querySelectorAll('.flash-close');
        closeButtons.forEach(button => {
          button.addEventListener('click', () => {
            const message = button.closest('.flash-message');
            message.classList.add('is-hiding');
            // Remove the element from the DOM after the animation completes
            message.addEventListener('transitionend', () => message.remove());
          });
        });

        // --- 3. Reusable Custom Confirmation Modal Logic ---
        const modal = document.getElementById('confirmation-modal');
        if (modal) {
          const modalTitle = modal.querySelector('.modal-title');
          const modalBody = modal.querySelector('.modal-body');
          const confirmBtn = document.getElementById('modal-confirm-btn');
          const cancelBtn = document.getElementById('modal-cancel-btn');
          let formToSubmit = null; // Variable to hold the form that needs submitting

          // Find all forms that require confirmation via a data attribute
          document.querySelectorAll('form[data-confirm]').forEach(form => {
            form.addEventListener('submit', (e) => {
              e.preventDefault(); // Prevent the form from submitting immediately
              formToSubmit = e.target;

              // Get custom messages from the form's data attributes
              const title = form.dataset.confirmTitle || 'Confirmation Required';
              const message = form.dataset.confirm;

              // Populate and show the modal
              modalTitle.textContent = title;
              modalBody.textContent = message;
              modal.classList.remove('hidden');
            });
          });

          // Function to hide the modal
          const hideModal = () => {
            modal.classList.add('hidden');
            formToSubmit = null; // Clear the stored form
          };

          // If the user clicks the final "Confirm" button, submit the stored form
          confirmBtn.addEventListener('click', () => {
            if (formToSubmit) {
              formToSubmit.submit();
            }
          });

          // Add event listeners to hide the modal
          cancelBtn.addEventListener('click', hideModal);
          modal.addEventListener('click', (e) => {
            // Hide if the user clicks on the dark overlay background
            if (e.target === modal) {
              hideModal();
            }
          });
        }

        // --- 4. Achievement Toast Notification Logic ---
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
          const showToast = (achievement) => {
            const toast = document.createElement('div');
            toast.className = 'toast-notification toast-achievement';
            toast.innerHTML = `
                    <div class="toast-icon"><i class="bi ${achievement.icon}"></i></div>
                    <div class="toast-content">
                        <div class="toast-title">Achievement Unlocked!</div>
                        <div class="toast-message">${achievement.name}</div>
                    </div>
                `;
            toastContainer.appendChild(toast);
            // Animate in
            setTimeout(() => toast.classList.add('show'), 100);
            // Animate out and remove after 5 seconds
            setTimeout(() => {
              toast.classList.remove('show');
              setTimeout(() => toast.remove(), 500);
            }, 5000);
          };

          // Check for flashed achievement messages passed from the server
          const achievements = !{JSON.stringify(messages.achievement_unlocked || [])};
          if (achievements && achievements.length > 0) {
            achievements.forEach(achJSON => {
              try {
                const achievement = JSON.parse(achJSON);
                showToast(achievement);
              } catch (e) {
                console.error('Failed to parse achievement toast data:', e);
              }
            });
          }
        }
      });

    //- Define a block where child templates can inject their own scripts
    block scripts