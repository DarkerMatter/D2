extends layout

block content
    .session-container
        #session-title
            h2#session-name-display= session.name
            span#session-date-display(data-timestamp=session.created_at)

        //- Grid to display session stats (Restored from your original file)
        .stats-grid
            .stat-card
                h3 Session Total Rage
                p.rage-score= stats.totalRage
            .stat-card
                h3 Deaths This Session
                p.rage-score= stats.totalDeaths
            .stat-card
                h3 Session Avg. Rage
                p.stat-value= stats.averageRage
            .stat-card
                h3 Session Go-To Phrase
                p.stat-value= stats.mostCommonPhrase

        //- Log a death form (only shown for active sessions)
        if session.is_active
            .admin-section-card
                h3 Log a New Death
                //- FIX: Updated form action to match the new route
                form.log-death-form(action=`/session/${session.id}/log-death`, method="POST")
                    .form-group
                        label Rage Level (1-10)
                        .choice-grid.rage-level-grid
                            each level in [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                                button.choice-btn(type="button", data-value=level)= level
                        input(type="hidden", name="rageLevel", required)
                    .form-group
                        label Rage Phrase
                        input(type="text", name="ragePhrase", placeholder="e.g., 'This is outrageous!'", required)
                    .form-group.form-button-group
                        button.btn-rage(type="submit") Log Death

        //- Session logs table
        .admin-section-card
            h3 Session Logs
            if logs.length > 0
                .user-table-container
                    table.user-table
                        thead
                            tr
                                th Time
                                th Rage Level
                                th Rage Phrase
                        tbody
                            each log in logs
                                tr
                                    td(data-timestamp=log.created_at)
                                    td= log.rage_level
                                    td= log.rage_phrase
            else
                p No deaths have been logged for this session yet.

        //- NEW: Container for the End Session and Dashboard buttons
        .session-actions
            if session.is_active
                form(action=`/session/${session.id}/end`, method="POST", data-confirm=`Are you sure you want to end the session "${session.name}"? This will calculate your final achievements.`, data-confirm-title="End Session")
                    button.btn.btn-danger(type="submit") End Session & Calculate Achievements
            a.btn.btn-secondary(href="/dashboard") Return to Dashboard

block scripts
    script.
        document.addEventListener('DOMContentLoaded', () => {
            // Timestamp formatting
            document.querySelectorAll('[data-timestamp]').forEach(el => {
                const timestamp = el.getAttribute('data-timestamp');
                if (timestamp) {
                    el.textContent = new Date(timestamp).toLocaleString();
                }
            });

            // Choice button logic for rage level
            const rageGrid = document.querySelector('.rage-level-grid');
            if (rageGrid) {
                const hiddenInput = document.querySelector('input[name="rageLevel"]');
                const buttons = rageGrid.querySelectorAll('.choice-btn');

                buttons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const selectedValue = button.dataset.value;

                        // Update hidden input
                        hiddenInput.value = selectedValue;

                        // Update button styles
                        buttons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                    });
                });
            }
        });